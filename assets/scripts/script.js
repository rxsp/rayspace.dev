/*!
  script.js v1.2
  (c) 2023 rxsp
 */
  let isPageFirstLoaded=!0;const root="https://rayspace.dev",navLinks=document.querySelectorAll(".sidenav .sidenav-link"),highlight=document.createElement("span");async function fetchTotalViews(){try{const t=await fetch("/api/posts");if(!t.ok)throw new Error("Failed to fetch total views.");const e=(await t.json()).reduce(((t,e)=>t+e.views),0);document.querySelector("#blogViewsCount").textContent=`${e.toLocaleString()} blog views all time`}catch(t){console.error(t)}}async function fetchRecentSignee(){try{const t=await fetch("/api/comments");if(!t.ok)throw new Error("Failed to fetch recent signee.");const e=await t.json();e.sort(((t,e)=>e.id-t.id));const n=e[0].name;document.querySelector("#recentSignee").textContent=`Recent signee: ${n}`}catch(t){console.error(t)}}async function fetchGithubStars(){try{const t=await fetch("/api/github_stars");if(!t.ok)throw new Error("Failed to fetch Github stars.");const e=(await t.json()).stars,n=document.querySelector("#githubStars");n.textContent=e>0?`${e} stars on this repo`:"View this repo"}catch(t){console.error(t);document.querySelector("#githubStars").textContent="View this repo"}}async function handleSubmit(t){t.preventDefault();let e=document.getElementById("comment-input"),n=e.value.trim();if(""!==n){n=DOMPurify.sanitize(n);try{const t=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:n})});if(!t.ok)throw new Error("Failed to submit comment.");await t.json();fetchGuestbookComments(),e.value=""}catch(t){console.error(t)}}}async function fetchUserStatus(){const t=await fetch("/api/user_status");if(t.ok){return await t.json()}return console.error("Failed to fetch user status."),null}async function logout(){(await fetch("/auth/logout",{method:"POST"})).ok?(document.querySelector(".sign-out-button").classList.add("hidden"),document.querySelector(".input-container").classList.add("hidden"),document.querySelector(".github-signin").classList.remove("hidden")):console.error("Failed to log out.")}async function fetchMetadataAndSetActiveLink(t){const e=await fetch("/api/posts");let n;n=(await e.json()).map((t=>`/blog/${convertToDashed(t.title)}`)).includes(t)?document.querySelector('.sidenav .sidenav-link[href="/blog"]'):document.querySelector(`.sidenav .sidenav-link[href="${t}"]`),n&&(n.classList.add("active"),highlightLink.call(n)),loadPage(t),isPageFirstLoaded=!1}function getCurrentUrl(){const t=window.location.pathname;return"/"===t?"/home":t}async function loadPage(t){try{const e=t||window.location.pathname;if(e.startsWith("/blog")){const t=await fetch("/api/posts");if(!t.ok)throw new Error("Failed to fetch blog posts");const n=await t.json(),o=n.map((t=>`/blog/${convertToDashed(t.title)}`));if(o.includes(e)){const t=o.indexOf(e),i=n[t].id,a=await fetch(`/posts/${i}.html`);if(!a.ok)throw new Error("Failed to fetch post HTML");const c=await a.text();document.querySelector(".content").innerHTML=c,hljs.highlightAll(),fetchMetadata(),updateViews(n[t].id)}else loadPageContent(e)}else loadPageContent(e)}catch(t){console.error(t)}}async function fetchGuestbookComments(){try{const t=await fetch("/api/comments");if(!t.ok)throw new Error("Failed to fetch guestbook comments");const e=await t.json();Array.isArray(e)&&displayComments(e)}catch(t){console.error(t)}}function displayComments(t){const e=document.querySelector(".guestbook-comments");e.innerHTML="",[...t].forEach((t=>{const n=document.createElement("p");n.classList.add("comment");const o=document.createElement("span");o.classList.add("comment-name"),o.textContent=`${t.name}: `;const i=document.createElement("span");i.classList.add("comment-message"),i.textContent=t.comment,n.appendChild(o),n.appendChild(i),e.appendChild(n)}))}async function updateViews(t){try{if(!(await fetch(`/api/update_views/${t}`,{method:"PUT"})).ok)throw new Error(`Failed to update views for post ID: ${t}`)}catch(t){console.error(t)}}function loadPageContent(t){const e={"/":"./pages/home.html","/home":"./pages/home.html","/about":"./pages/about.html","/guestbook":"./pages/guestbook.html","/blog":"./pages/blog.html","/resume":"./pages/resume.html","/404":"./pages/404.html"};e[t]?fetch(e[t]).then((t=>t.text())).then((e=>{if(document.querySelector(".content").innerHTML=e,"/404"===t)for(var n=document.querySelectorAll("blockquote"),o=Math.floor(Math.random()*n.length),i=0;i<n.length;i++)n[i].style.display=i===o?"block":"none";if(updateMetaTitle(capitalize(t.replace("/",""))),"/blog"===t){document.querySelectorAll(".post-link").forEach((t=>{t.addEventListener("click",handleBlogLinkClick)}))}if(document.querySelectorAll(".home-link").forEach((t=>{t.addEventListener("click",(e=>{e.preventDefault();const n=document.querySelector(`.sidenav-link[href="${t.getAttribute("href")}"]`);n&&n.click()}))})),highlightLink.call(document.querySelector(".sidenav .sidenav-link.active")),"/about"===t){document.querySelector(".content").innerHTML=e;let t=document.querySelector(".resume-link");t&&t.addEventListener("click",(e=>{e.preventDefault(),loadPage("/resume");const n=t.getAttribute("href");history.pushState(null,null,n)}))}if("/home"!==t&&"/"!==t||(fetchGithubStars(),fetchTotalViews(),fetchRecentSignee()),"/guestbook"===t){const t=document.querySelector(".input-container"),e=document.querySelector(".sign-out-button"),n=document.querySelector(".github-signin");fetchUserStatus().then((o=>{if(o.authenticated){t.classList.remove("hidden"),e.classList.remove("hidden"),n.classList.add("hidden");let o=document.getElementById("comment-form");o&&o.addEventListener("submit",handleSubmit)}else t.classList.add("hidden"),e.classList.add("hidden"),n.classList.remove("hidden")})),fetchGuestbookComments()}"/blog"===t&&fetchMetadata()})).catch((t=>{})):window.location.href="/404"}function handleGithubSignIn(t){t.preventDefault(),window.location.href="/auth/start_github_oauth"}function handleBlogLinkClick(t){t.preventDefault();const e=this.getAttribute("href");history.pushState(null,null,e),loadPage(e)}function highlightLink(){const{width:t,height:e,top:n,left:o}=this.getBoundingClientRect(),i=highlight.parentNode.getBoundingClientRect();Object.assign(highlight.style,{width:`${t}px`,height:`${e}px`,transform:`translate(${o-i.left}px, ${n-i.top}px)`,opacity:isPageFirstLoaded?0:1,transition:isPageFirstLoaded?"none":"transform 0.2s, width 0.2s, height 0.2s"}),isPageFirstLoaded&&setTimeout((()=>{highlight.style.opacity=1}),100)}async function fetchMetadata(){try{const t=await fetch("/api/posts");if(!t.ok)throw new Error("Network response was not ok.");const e=await t.json();e.sort(((t,e)=>t.id-e.id));const n=e.map((t=>t.title)),o=n.map((t=>`/blog/${convertToDashed(t)}`)),i=getCurrentUrl();if("/blog"===i){const t=document.querySelector(".posts");t.innerHTML="",e.forEach(((e,n)=>{const i=document.createElement("p");i.classList.add("post-link"),i.textContent=e.title;const a=document.createElement("p");a.classList.add("post-views"),a.textContent=`${e.views.toLocaleString()} views`;const c=document.createElement("div");c.classList.add("post-divider");const s=document.createElement("a");s.classList.add("post-list-item"),s.appendChild(i),s.appendChild(a),s.appendChild(c),s.href=o[n],s.addEventListener("click",handleBlogLinkClick),t.appendChild(s)}))}else if(o.includes(i)){const t=o.indexOf(i),a=n[t];document.querySelectorAll(".post-title").forEach((t=>{t.textContent=a}));const c=document.createElement("div");c.classList.add("post-info-container");const s=document.createElement("span");s.classList.add("post-date"),s.textContent=e[t].published_date;const r=document.createElement("span");r.classList.add("post-views"),r.textContent=`${e[t].views.toLocaleString()} views`;const l=document.createElement("hr");l.classList.add("post-info-line"),c.appendChild(s),c.appendChild(l),c.appendChild(r);document.querySelector(".content");const d=document.querySelector(".post-title");d.parentNode.insertBefore(c,d.nextSibling),updateMetaTitle(a);const u=document.getElementById("content").getElementsByTagName("p")[0].textContent;updateOGTags(a,u,root+i,"article","")}}catch(t){console.error(`Fetch operation failed: ${t.message}`)}}function convertToDashed(t){return t.toLowerCase().replace(/\s+/g,"-")}function capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}function updateMetaTitle(t){const e=document.querySelector("title"),n="Ray Space",o=root;e.text="Home"!==t?t+" | Ray Space":n,updateOGTags(n,"Full-Stack Software Engineer",o,"website")}function updateOGTags(t,e,n,o){document.querySelector('meta[name="description"]').setAttribute("content",e),document.querySelector('meta[property="og:title"]').setAttribute("content",t),document.querySelector('meta[property="og:description"]').setAttribute("content",e),document.querySelector('meta[property="og:url"]').setAttribute("content",n),document.querySelector('meta[property="og:type"]').setAttribute("content",o),document.querySelector('meta[name="twitter:title"]').setAttribute("content",t),document.querySelector('meta[name="twitter:description"]').setAttribute("content",e)}function copyToClipboard(){const t=document.createElement("textarea");t.textContent=document.getElementById("code").textContent,t.style.position="fixed",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(t){return!1}finally{document.body.removeChild(t),document.getElementById("copy-icon").style.opacity="0",document.getElementById("checkmark-icon").style.opacity="1",setTimeout((function(){document.getElementById("copy-icon").style.opacity="1",document.getElementById("checkmark-icon").style.opacity="0"}),2e3)}}highlight.classList.add("highlight"),document.querySelector(".sidenav").append(highlight),window.onload=()=>{const t=getCurrentUrl();if(t.startsWith("/blog"))fetchMetadataAndSetActiveLink(t);else{let e;e="/resume"===t?document.querySelector('.sidenav .sidenav-link[href="/about"]'):document.querySelector(`.sidenav .sidenav-link[href="${t}"]`),e&&(e.classList.add("active"),highlightLink.call(e)),loadPage(t),isPageFirstLoaded=!1}},window.addEventListener("popstate",(()=>{const t=getCurrentUrl();if(navLinks.forEach((t=>t.classList.remove("active"))),t.startsWith("/blog"))fetchMetadataAndSetActiveLink(t);else{let e;e="/resume"===t?document.querySelector('.sidenav .sidenav-link[href="/about"]'):document.querySelector(`.sidenav .sidenav-link[href="${t}"]`),e&&(e.classList.add("active"),highlightLink.call(e)),loadPage(t)}})),navLinks.forEach((t=>{t.addEventListener("click",(e=>{e.preventDefault(),navLinks.forEach((t=>t.classList.remove("active"))),t.classList.add("active");const n=t.getAttribute("href");history.pushState(null,null,n),"/home"===n&&history.replaceState(null,null,"/"),loadPage(n);"/404"===window.location.pathname?highlight.style.display="none":(highlight.style.display="block",highlightLink.call(t))}))})),window.addEventListener("resize",(()=>{highlightLink.call(document.querySelector(".sidenav .sidenav-link.active"))}));
